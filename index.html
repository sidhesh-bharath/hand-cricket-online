<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hand Cricket Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --card: #111; --sky: #00d2ff; --text: #fff; --mute: #444; --brd: #222; --rage: #ff3e3e; --gold: #ffd700; }
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; touch-action: manipulation; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #app { width: 100%; max-width: 420px; height: 100dvh; display: flex; flex-direction: column; padding: 24px; position: relative; justify-content: center; }
        .view { display: none; flex-direction: column; width: 100%; }
        .view.active { display: flex; }
        h1 { font-size: 2.8rem; font-weight: 800; margin: 0; letter-spacing: -2px; line-height: 0.9; text-align: center; }
        .sub-tag { color: var(--sky); font-size: 0.75rem; letter-spacing: 4px; font-weight: 700; text-transform: uppercase; margin-bottom: 30px; margin-top: 5px; text-align: center; }
        .card { background: var(--card); border-radius: 24px; padding: 24px; border: 1px solid var(--brd); margin-bottom: 20px; transition: 0.3s; position: relative; }
        .reveal-box { display: flex; justify-content: space-between; align-items: center; text-align: center; }
        .player-slot { flex: 1; }
        .val { font-size: 3.5rem; font-weight: 800; margin: 5px 0; transition: 0.2s; color: var(--text); }
        .label { font-size: 0.65rem; font-weight: 600; color: var(--mute); text-transform: uppercase; letter-spacing: 1px; }
        .score-chip { background: rgba(0,210,255,0.1); color: var(--sky); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; display: inline-block; transition: 0.3s; }
        
        /* RESTORED & IMPROVED: Gold Chip */
        .score-gold { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 25px rgba(255,215,0,0.7); transform: scale(1.1); font-weight: 900; }
        
        /* UI ANIMATIONS */
        #outPopup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--rage); color: white; padding: 18px 50px; border-radius: 50px; font-weight: 900; font-size: 2.2rem; z-index: 3000; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 40px rgba(255, 62, 62, 0.7); pointer-events: none; opacity: 0; }
        #outPopup.show { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        
        #targetBanner { position: absolute; top: -120px; left: 0; width: 100%; background: var(--sky); color: #000; padding: 25px; text-align: center; font-weight: 900; font-size: 1.3rem; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2500; letter-spacing: 2px; box-shadow: 0 10px 30px rgba(0, 210, 255, 0.4); }
        #targetBanner.show { top: 0; }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        button { background: var(--text); color: #000; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.1s; font-size: 1rem; }
        .grid button { background: var(--card); color: var(--text); border: 1px solid var(--brd); font-size: 1.2rem; }
        .grid button:active { background: var(--mute); transform: scale(0.95); }
        .grid button:disabled { opacity: 0.1; cursor: default; }
        .btn-main { width: 100%; margin-top: 12px; padding: 20px; }
        .btn-sec { background: transparent; color: var(--text); border: 1px solid var(--brd); }
        .btn-rage { background: var(--rage); color: white; margin-top: 20px; }
        input { width: 100%; background: var(--card); border: 1px solid var(--brd); padding: 20px; border-radius: 14px; color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 12px; font-weight: 600; outline: none; }
        
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; text-align: center; padding: 40px; }
        .res-split { display: flex; align-items: center; gap: 20px; margin: 30px 0; width: 100%; }
        .res-side { flex: 1; }
        .res-num { font-size: 3rem; font-weight: 800; color: var(--text); }
        .res-mid { font-size: 1.5rem; color: var(--mute); font-weight: 900; }
        #matchStatus { text-align:center; font-weight:800; color:var(--sky); font-size: 0.7rem; letter-spacing: 1px; margin-top: 15px; height: 20px; text-transform: uppercase;}
    </style>
</head>
<body>

<div id="app">
    <div id="outPopup">OUT!</div>
    <div id="targetBanner"><span id="targetContext">TARGET SET</span>: <span id="targetVal">0</span></div>

    <div id="v-lobby" class="view active">
        <h1>HAND<br>CRICKET</h1>
        <div class="sub-tag">PRO EDITION</div>
        <button class="btn-main" onclick="startCPU()">PLAY COMPUTER</button>
        <div style="text-align:center; margin: 25px 0 10px; color: var(--mute); font-size: 0.7rem; font-weight: 700; letter-spacing: 2px;">MULTIPLAYER</div>
        <input type="text" id="joinInp" placeholder="4-DIGIT CODE" maxlength="4" autocomplete="off">
        <button class="btn-main btn-sec" onclick="joinRoom()">JOIN MATCH</button>
        <button class="btn-main btn-sec" onclick="createRoom()">CREATE ROOM</button>
    </div>

    <div id="v-wait" class="view">
        <div class="sub-tag">MATCH ROOM</div>
        <div class="card"><div class="label">SHARE CODE</div><div id="roomDisplay" style="font-size: 3.5rem; font-weight: 800; text-align: center;">----</div></div>
        <button class="btn-main" id="copyBtn" onclick="copyRoom()">COPY CODE</button>
    </div>

    <div id="v-toss" class="view">
        <div class="sub-tag">THE TOSS</div>
        <h2 id="tossMsg" style="margin-bottom: 20px; text-align: center;">PICK A NUMBER</h2>
        <div id="hostTossUI" style="display:none; gap:10px; margin-bottom:15px;">
            <button id="t-ODD" class="btn-main" style="flex:1" onclick="setSide('ODD')">ODD</button>
            <button id="t-EVEN" class="btn-main btn-sec" style="flex:1" onclick="setSide('EVEN')">EVEN</button>
        </div>
        <div class="grid" id="tossGrid"></div>
    </div>

    <div id="v-choice" class="view">
        <div class="sub-tag">TOSS WON</div>
        <h2 id="choiceMsg" style="margin-bottom: 30px; text-align: center;">DECIDE YOUR ROLE</h2>
        <button class="btn-main" onclick="pickRole('BATTING')">BATTING</button>
        <button class="btn-main btn-sec" onclick="pickRole('BOWLING')">BOWLING</button>
    </div>

    <div id="v-game" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div id="roleTag" class="score-chip" style="font-size: 0.7rem; background: var(--text); color: #000;">...</div>
            <div id="innTag" class="score-chip" style="font-size: 0.7rem; opacity: 0.6;">INN 1</div>
        </div>
        <div class="card" id="gameCard">
            <div id="tarTag" style="color:var(--sky); font-size:0.75rem; font-weight:800; margin-bottom:15px; visibility:hidden;">TARGET: 0</div>
            <div class="reveal-box">
                <div class="player-slot"><div class="label">YOU</div><div class="val" id="m1">-</div><div class="score-chip" id="s1">0</div></div>
                <div style="font-weight: 900; color: var(--mute); font-size: 1.2rem;">VS</div>
                <div class="player-slot"><div class="label">OPPONENT</div><div class="val" id="m2">-</div><div class="score-chip" id="s2">0</div></div>
            </div>
        </div>
        <div id="matchStatus">GET READY!</div>
        <div class="grid" id="gameGrid"></div>
        <button class="btn-main btn-rage" onclick="ragequit()">RAGEQUIT</button>
    </div>

    <div id="overlay">
        <div class="sub-tag">MATCH OVER</div>
        <h1 id="resTitle" style="color:var(--sky)">VICTORY</h1>
        <div class="res-split">
            <div class="res-side"><div class="label">YOU</div><div class="res-num" id="finalS1">0</div></div>
            <div class="res-mid">VS</div>
            <div class="res-side"><div class="label">OPP</div><div class="res-num" id="finalS2">0</div></div>
        </div>
        <div id="historyLog" style="font-size: 0.8rem; color: var(--mute);"></div>
        <div class="final-ball" id="resBall" style="margin-top: 10px; font-weight: 800;"></div>
        <button class="btn-main" onclick="location.reload()">PLAY AGAIN</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const db = getDatabase(initializeApp({ databaseURL: "https://hand-cricket-4581f-default-rtdb.asia-southeast1.firebasedatabase.app/" }));
    let rID = null, isHost = false, isCPU = false, tSide = 'ODD', localM = null, gameActive = true;

    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(freq, type, dur, vol=0.1) {
        const osc = audio.createOscillator(); const gain = audio.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audio.currentTime);
        gain.gain.setValueAtTime(vol, audio.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + dur);
        osc.connect(gain); gain.connect(audio.destination); osc.start(); osc.stop(audio.currentTime + dur);
    }

    function playCheer() {
        const bufferSize = audio.sampleRate * 2.0;
        const buffer = audio.createBuffer(1, bufferSize, audio.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audio.createBufferSource(); noise.buffer = buffer;
        const filter = audio.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 1200;
        const gain = audio.createGain(); gain.gain.setValueAtTime(0.06, audio.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + 2.0);
        noise.connect(filter); filter.connect(gain); gain.connect(audio.destination); noise.start();
    }

    document.addEventListener('keydown', (e) => {
        if(!gameActive) return;
        let n = (e.key >= '0' && e.key <= '9') ? parseInt(e.key) : (e.key === '-' ? 10 : null);
        if(n === null || document.activeElement.tagName === 'INPUT') return;
        playSfx(400, 'sine', 0.05, 0.05);
        if(document.getElementById('v-toss').classList.contains('active')) handleToss(n);
        if(document.getElementById('v-game').classList.contains('active')) handleMove(n);
    });

    const triggerOut = () => {
        const el = document.getElementById('outPopup');
        el.classList.add('show');
        playSfx(100, 'sawtooth', 0.8, 0.2);
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        setTimeout(() => el.classList.remove('show'), 2000);
    };

    const triggerTarget = (val, amBattingNow) => {
        const el = document.getElementById('targetBanner');
        document.getElementById('targetVal').innerText = val;
        document.getElementById('targetContext').innerText = amBattingNow ? "CHASE BEGINS" : "DEFEND THE TARGET";
        el.classList.add('show');
        playSfx(523, 'sine', 0.5, 0.1); 
        setTimeout(() => el.classList.remove('show'), 4000);
    };

    const navigate = (id) => { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(`v-${id}`).classList.add('active'); };
    const createGrid = (id, fn) => {
        const g = document.getElementById(id); g.innerHTML = '';
        for(let i=0; i<=10; i++){
            let b = document.createElement('button'); b.innerText = i; b.onclick = () => { playSfx(440, 'sine', 0.1, 0.1); fn(i); }; b.id = `${id}-${i}`; g.appendChild(b);
        }
    };

    function listen() {
        onValue(ref(db, 'rooms/'+rID), (s) => {
            const d = s.val(); if(!d) return;
            if(d.state === 'CHOICE' || d.state === 'TOSS') { navigate(d.state.toLowerCase()); }
            if(d.state === 'PLAYING') {
                if(d.triggerOut) { triggerOut(); update(ref(db, 'rooms/'+rID), {triggerOut: false}); }
                const amBat = (d.inn===1) ? (isHost ? d.p1Role==='BATTING' : d.p1Role!=='BATTING') : (isHost ? d.p1Role!=='BATTING' : d.p1Role==='BATTING');
                if(d.triggerTar) { triggerTarget(d.tar, amBat); update(ref(db, 'rooms/'+rID), {triggerTar: false}); }
                
                navigate('game');
                document.getElementById('s1').innerText = isHost ? d.s1 : d.s2;
                document.getElementById('s2').innerText = isHost ? d.s2 : d.s1;
                document.getElementById('innTag').innerText = `INN ${d.inn}`;
                document.getElementById('roleTag').innerText = amBat ? "BATTING" : "BOWLING";

                // Gold Chip & Sfx
                const lastMove = isHost ? d.l1 : d.l2;
                if(amBat && (lastMove === 6 || lastMove === 10)) {
                    document.getElementById('s1').classList.add('score-gold');
                    playSfx(880, 'square', 0.3, 0.15); playCheer();
                    if(navigator.vibrate) navigator.vibrate(100);
                } else document.getElementById('s1').classList.remove('score-gold');

                // Match Status Updates
                if(d.inn === 2) {
                    const myScore = isHost ? d.s1 : d.s2;
                    const oppScore = isHost ? d.s2 : d.s1;
                    if(amBat) document.getElementById('matchStatus').innerText = `NEED ${d.tar - myScore} RUNS TO WIN`;
                    else document.getElementById('matchStatus').innerText = `DEFEND ${d.tar - oppScore - 1} MORE RUNS`;
                } else document.getElementById('matchStatus').innerText = amBat ? "BUILD A BIG TOTAL" : "GET THE WICKET";

                document.getElementById('m1').innerText = (isHost?d.m1:d.m2) === -1 ? (localM||'-') : (isHost?d.m1:d.m2);
                document.getElementById('m2').innerText = (isHost?d.m2:d.m1) === -1 ? '-' : (isHost?d.m2:d.m1);
                document.getElementById('tarTag').style.visibility = d.tar > 0 ? 'visible' : 'hidden';
                if(d.tar > 0) document.getElementById('tarTag').innerText = `TARGET: ${d.tar}`;
                
                if(isHost && d.m1 !== -1 && d.m2 !== -1) { localM = null; setTimeout(() => engine(d), 600); }
            }
            if(d.state === 'END') renderEnd(d);
        });
    }

    function engine(d) {
        let {m1, m2, s1, s2, inn, tar, i1} = d, st = 'PLAYING', tout = false, ttar = false;
        const p1B = (inn === 1) ? (d.p1Role === 'BATTING') : (d.p1Role !== 'BATTING');
        if(m1 === m2) { 
            tout = true;
            if(inn === 1) { inn = 2; i1 = (p1B?s1:s2); tar = i1+1; ttar = true; } else st = 'END';
        } else { 
            let p = p1B ? (m1===0?m2:m1) : (m2===0?m1:m2); if(p1B) s1 += p; else s2 += p; 
            if(inn===2 && (p1B?s1:s2)>=tar) st = 'END';
        }
        update(ref(db, 'rooms/'+rID), { s1, s2, m1:-1, m2:-1, l1:m1, l2:m2, inn, tar, i1, state:st, triggerOut: tout, triggerTar: ttar });
    }

    function renderEnd(d) {
        gameActive = false; document.getElementById('overlay').style.display='flex';
        let s1 = isCPU ? cs.s1 : (isHost ? d.s1 : d.s2), s2 = isCPU ? cs.s2 : (isHost ? d.s2 : d.s1);
        document.getElementById('finalS1').innerText = s1; document.getElementById('finalS2').innerText = s2;
        let title = s1 > s2 ? "VICTORY" : (s1 === s2 ? "DRAW" : "DEFEAT");
        if(d.rq) title = (d.rq === (isHost?'p1':'p2')) ? "YOU RAGEQUIT ðŸ¤£" : "OPPONENT LEFT";
        document.getElementById('resTitle').innerText = title;
        document.getElementById('resBall').innerText = `FINAL BALL: ${isCPU?cs.l1:(isHost?d.l1:d.l2)} vs ${isCPU?cs.l2:(isHost?d.l2:d.l1)}`;
        document.getElementById('historyLog').innerText = `Inning 1 Score: ${isCPU?cs.i1:d.i1}`;
        playSfx(s1 >= s2 ? 523 : 200, 'sine', 1, 0.2);
    }

    window.ragequit = () => { if(rID && !isCPU) update(ref(db, 'rooms/'+rID), {rq: isHost?'p1':'p2', state:'END'}); else location.reload(); };
    window.createRoom = () => { rID = Math.floor(1000+Math.random()*9000).toString(); isHost = true; set(ref(db, 'rooms/'+rID), { state:'LOBBY', tSide:'ODD', t1:-1, t2:-1, s1:0, s2:0, m1:-1, m2:-1, l1:'-', l2:'-', inn:1, tar:0, i1:0 }); document.getElementById('roomDisplay').innerText = rID; navigate('wait'); listen(); };
    window.joinRoom = () => { const code = document.getElementById('joinInp').value.trim(); if(/^\d{4}$/.test(code)) get(ref(db, 'rooms/'+code)).then(s => { if(s.exists()){ rID = code; isHost = false; update(ref(db, 'rooms/'+code), { state:'TOSS' }); listen(); } }); };
    window.setSide = (s) => { tSide = s; document.getElementById('t-ODD').className = s==='ODD'?'btn-main':'btn-main btn-sec'; document.getElementById('t-EVEN').className = s==='EVEN'?'btn-main':'btn-main btn-sec'; };
    window.pickRole = (c) => { if(isCPU) { cs.role = c; navigate('game'); return; } update(ref(db, 'rooms/'+rID), { p1Role: isHost?c:(c==='BATTING'?'BOWLING':'BATTING'), state:'PLAYING' }); };
    function handleToss(n) { if(isCPU) return cpuToss(n); update(ref(db, 'rooms/'+rID), { [isHost?'t1':'t2']: n, tSide: tSide }); }
    function handleMove(n) { localM = n; document.getElementById('m1').innerText = n; if(isCPU) return cpuMove(n); update(ref(db, `rooms/${rID}`), { [isHost?'m1':'m2']: n }); }

    // CPU
    let cs = { s1:0, s2:0, inn:1, tar:0, role:'BATTING', l1:0, l2:0, i1:0 };
    window.startCPU = () => { isCPU = true; navigate('toss'); };
    function cpuToss(n) { navigate('choice'); }
    function cpuMove(n) {
        let cn = Math.floor(Math.random()*11); document.getElementById('m1').innerText = n; document.getElementById('m2').innerText = cn;
        cs.l1 = n; cs.l2 = cn;
        if(n === cn) { triggerOut();
            if(cs.inn === 1) { cs.inn = 2; cs.i1 = (cs.role==='BATTING'?cs.s1:cs.s2); cs.tar = cs.i1+1; cs.role = (cs.role==='BATTING'?'BOWLING':'BATTING'); setTimeout(()=>triggerTarget(cs.tar, cs.role==='BATTING'), 1500); }
            else renderEnd({});
        } else {
            if(cs.role==='BATTING') { cs.s1 += (n===0?cn:n); if(n===6||n===10) playCheer(); } else cs.s2 += (cn===0?n:cn);
            if(cs.inn===2 && (cs.role==='BATTING'?cs.s1:cs.s2)>=cs.tar) renderEnd({});
        }
        document.getElementById('s1').innerText = cs.s1; document.getElementById('s2').innerText = cs.s2;
        document.getElementById('roleTag').innerText = cs.role;
    }
    window.copyRoom = () => { navigator.clipboard.writeText(rID); document.getElementById('copyBtn').innerText = "COPIED!"; };
    createGrid('tossGrid', handleToss); createGrid('gameGrid', handleMove);
</script>
</body>
</html>