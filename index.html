<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hand Cricket Pro: Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #111111; --sky: #38bdf8; --text: #f8fafc; --mute: #64748b; --brd: #262626; --rage: #ef4444; --gold: #eab308; --crazy: #c084fc; --win: #22c55e; }
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; touch-action: manipulation; outline: none; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        #app { width: 100%; max-width: 420px; height: 100dvh; display: flex; flex-direction: column; padding: 20px; position: relative; }
        .view { display: none; flex-direction: column; width: 100%; animation: fade 0.3s ease-out; }
        .view.active { display: flex; }
        @keyframes fade { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* HEADER */
        .brand { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 3.5rem; font-weight: 900; margin: 0; letter-spacing: -3px; line-height: 0.8; background: linear-gradient(to bottom, #fff, #666); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge { font-size: 0.6rem; font-weight: 800; letter-spacing: 4px; color: var(--sky); text-transform: uppercase; margin-top: 10px; }

        /* GAME BOARD */
        .board { background: linear-gradient(160deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid var(--brd); border-radius: 32px; padding: 25px; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); }
        .status-pill { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #333; padding: 5px 15px; border-radius: 20px; font-size: 0.6rem; font-weight: 800; color: var(--sky); white-space: nowrap; }
        
        .scores { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .score-box { text-align: center; flex: 1; }
        .score-val { font-size: 2.2rem; font-weight: 900; line-height: 1; }
        .score-label { font-size: 0.6rem; color: var(--mute); font-weight: 700; margin-top: 5px; letter-spacing: 1px; }
        .score-diff { font-size: 0.65rem; font-weight: 800; margin-top: 4px; height: 15px; }

        .vs-circle { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #222; background: #050505; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 900; color: #444; }

        .moves { display: flex; gap: 15px; margin-top: 25px; }
        .move-slot { flex: 1; background: rgba(0,0,0,0.4); height: 80px; border-radius: 20px; border: 1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; position: relative; }
        .move-slot::after { content: attr(data-label); position: absolute; bottom: -18px; font-size: 0.5rem; color: #444; font-weight: 800; }
        .move-num { font-size: 3rem; font-weight: 900; }
        .move-num.waiting { font-size: 1rem; color: var(--sky); animation: blink 1s infinite; }

        /* INPUTS */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 30px; }
        button { background: #fff; color: #000; border: none; padding: 18px; border-radius: 18px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.95); }
        .grid button { background: #161616; color: var(--mute); border: 1px solid #222; font-size: 1.2rem; }
        .grid button.selected { background: var(--sky); color: #000; box-shadow: 0 0 20px rgba(56,189,248,0.3); }
        .grid button:disabled { opacity: 0.2; }

        .btn-large { width: 100%; padding: 22px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-outline { background: transparent; color: #fff; border: 1px solid var(--brd); }
        .btn-crazy { background: transparent; color: var(--crazy); border: 1px solid var(--crazy); }
        
        input { width: 100%; background: #111; border: 1px solid var(--brd); padding: 22px; border-radius: 18px; color: #fff; text-align: center; font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; letter-spacing: 5px; }

        /* OVERLAYS */
        #fx-out { position: absolute; inset: 0; background: rgba(239, 68, 68, 0.2); display: none; z-index: 100; pointer-events: none; }
        #banner { position: absolute; top: -100px; left: 0; width: 100%; background: var(--sky); color: #000; padding: 20px; text-align: center; font-weight: 900; z-index: 1000; transition: 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.28); }
        #banner.show { top: 0; }

        .overlay { position: absolute; inset: 0; background: rgba(5,5,5,0.98); display: none; z-index: 9999; flex-direction: column; justify-content: center; padding: 30px; }
        .card { background: #111; border: 1px solid #222; border-radius: 30px; padding: 35px 25px; text-align: center; }
        
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="fx-out"></div>
<div id="banner">TARGET: 0</div>

<div id="app">
    <div id="v-lobby" class="view active">
        <div class="brand">
            <h1>HAND<br>CRICKET</h1>
            <div class="badge">PRO MULTIPLAYER</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-large" style="flex:1" onclick="initCPU('STANDARD')">VS CPU</button>
            <button class="btn-large btn-crazy" style="flex:1" onclick="initCPU('CRAZY')">CRAZY</button>
        </div>
        <div style="text-align:center; margin: 30px 0 15px; font-size: 0.6rem; font-weight: 800; color: #444; letter-spacing: 2px;">ONLINE ARENA</div>
        <input type="text" id="joinInp" placeholder="CODE" maxlength="4">
        <button class="btn-large btn-outline" onclick="initRoom()">HOST MATCH</button>
        <button class="btn-large btn-outline" style="margin-top:10px" onclick="joinRoom()">JOIN MATCH</button>
    </div>

    <div id="v-wait" class="view">
        <div class="badge" style="text-align:center">WAITING FOR PLAYER</div>
        <div class="board" style="text-align:center; margin-top:20px;">
            <div class="score-label">ROOM CODE</div>
            <div id="roomCode" style="font-size: 4rem; font-weight: 900; letter-spacing: 5px;">0000</div>
        </div>
        <button class="btn-large btn-outline" onclick="copyCode()">COPY CODE</button>
    </div>

    <div id="v-toss" class="view">
        <div class="badge" style="text-align:center">THE TOSS</div>
        <div class="board" style="margin-top:20px;">
            <div id="tossStatus" style="text-align:center; font-weight:800;">PICK A NUMBER</div>
        </div>
        <div id="tossControls" style="display:none; gap:10px; margin-top:20px;">
            <button id="btn-odd" class="btn-large" style="flex:1" onclick="setSide('ODD')">ODD</button>
            <button id="btn-even" class="btn-large btn-outline" style="flex:1" onclick="setSide('EVEN')">EVEN</button>
        </div>
        <div class="grid" id="tossGrid"></div>
    </div>

    <div id="v-choice" class="view">
        <div class="badge" style="text-align:center">TOSS WON</div>
        <div class="board" style="margin-top:20px; text-align:center;">
            <div id="tossSum" style="font-size: 3rem; font-weight: 900;">0</div>
            <div class="score-label">CHOOSE YOUR ROLE</div>
        </div>
        <button class="btn-large" onclick="pickRole('BATTING')">BATTING</button>
        <button class="btn-large btn-outline" style="margin-top:10px" onclick="pickRole('BOWLING')">BOWLING</button>
    </div>

    <div id="v-game" class="view">
        <div class="board">
            <div class="status-pill" id="innTag">1ST INNINGS</div>
            <div class="scores">
                <div class="score-box">
                    <div class="score-label">YOU</div>
                    <div class="score-val" id="s1">0</div>
                    <div class="score-diff" id="d1"></div>
                </div>
                <div class="vs-circle">VS</div>
                <div class="score-box">
                    <div class="score-label" id="oppLabel">CPU</div>
                    <div class="score-val" id="s2">0</div>
                    <div class="score-diff" id="d2"></div>
                </div>
            </div>
            <div class="moves">
                <div class="move-slot" data-label="YOU"><div class="move-num" id="m1">-</div></div>
                <div class="move-slot" data-label="OPP"><div class="move-num" id="m2">-</div></div>
            </div>
        </div>
        <div id="gameStatus" style="text-align:center; margin-top: 30px; font-weight: 800; font-size: 0.7rem; color: var(--sky); text-transform: uppercase;">GET READY</div>
        <div class="grid" id="gameGrid"></div>
    </div>

    <div id="overlay-end" class="overlay">
        <div class="card">
            <div class="badge">MATCH FINISHED</div>
            <h1 id="resTitle" style="background:none; -webkit-text-fill-color:white; font-size:3rem; margin:10px 0;">VICTORY</h1>
            <div id="resSub" style="font-size:0.7rem; font-weight:800; color:var(--mute); margin-bottom:25px;">YOU WON BY 24 RUNS</div>
            <div class="scores" style="margin-bottom:20px;">
                <div class="score-box"><div class="score-val" id="f1">0</div><div class="score-label">YOU</div></div>
                <div class="score-box"><div class="score-val" id="f2">0</div><div class="score-label">OPP</div></div>
            </div>
            <button class="btn-large" onclick="location.reload()">HOME</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const db = getDatabase(initializeApp({ databaseURL: "https://hand-cricket-4581f-default-rtdb.asia-southeast1.firebasedatabase.app/" }));

    // STATE
    let rID = null, isHost = false, isCPU = false, gameActive = true, localM = null;
    let tossSide = 'ODD';
    let g = { s1:0, s2:0, inn:1, tar:0, role:'BATTING', mode:'STANDARD' }; // Used for CPU
    
    // NAVIGATION
    const nav = (id) => { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(`v-${id}`).classList.add('active'); };

    // --- CPU LOGIC ---
    window.initCPU = (m) => { 
        isCPU = true; g.mode = m; 
        document.getElementById('oppLabel').innerText = "CPU";
        nav('toss'); 
    };

    window.cpuToss = (n) => {
        const cn = Math.floor(Math.random()*11);
        const win = (n+cn)%2 !== 0; // Human wins if odd
        nav('choice');
    };

    function runCPUTurn(n) {
        if(!gameActive) return;
        localM = n; renderMoves(n, '?');
        
        const cn = Math.floor(Math.random()*11);
        setTimeout(() => {
            renderMoves(n, cn);
            const humanBat = g.role === 'BATTING';
            const b = humanBat ? n : cn, w = humanBat ? cn : n;
            
            let isOut = (g.mode === 'CRAZY') ? Math.abs(b-w) === 1 : b === w;
            
            if(isOut) {
                fxOut();
                if(g.inn === 1) {
                    g.inn = 2; g.tar = (humanBat ? g.s1 : g.s2) + 1;
                    g.role = humanBat ? 'BOWLING' : 'BATTING';
                    showBanner(`TARGET: ${g.tar}`);
                } else {
                    endGame(g.s1, g.s2);
                }
            } else {
                let runs = (b === 0) ? w : b;
                if(g.mode === 'CRAZY' && b === w) runs = b*b;
                if(humanBat) g.s1 += runs; else g.s2 += runs;
                if(g.inn === 2 && (humanBat ? g.s1 : g.s2) >= g.tar) endGame(g.s1, g.s2);
            }
            
            setTimeout(() => {
                localM = null;
                updateUI();
                renderMoves('-', '-');
            }, 1000);
        }, 600);
    }

    // --- MULTIPLAYER LOGIC ---
    window.initRoom = () => {
        rID = Math.floor(1000 + Math.random() * 9000).toString(); isHost = true;
        set(ref(db, 'rooms/'+rID), { state:'LOBBY', tSide:'ODD', t1:-1, t2:-1, s1:0, s2:0, m1:-1, m2:-1, inn:1, tar:0 });
        document.getElementById('roomCode').innerText = rID; nav('wait'); listen();
    };

    window.joinRoom = () => {
        const c = document.getElementById('joinInp').value;
        get(ref(db, 'rooms/'+c)).then(s => { if(s.exists()){ rID = c; isHost = false; update(ref(db, 'rooms/'+c), { state:'TOSS' }); listen(); } });
    };

    function listen() {
        onValue(ref(db, 'rooms/'+rID), (s) => {
            const d = s.val(); if(!d) return;
            if(d.state === 'TOSS') { nav('toss'); document.getElementById('tossControls').style.display = isHost?'flex':'none'; updateTossGrid(d); }
            if(d.state === 'CHOICE') { const win = d.tWin === (isHost?'p1':'p2'); nav('choice'); }
            if(d.state === 'PLAYING') {
                nav('game');
                const amBat = (d.inn===1) ? (isHost ? d.p1Role==='BATTING' : d.p1Role!=='BATTING') : (isHost ? d.p1Role!=='BATTING' : d.p1Role==='BATTING');
                syncUI(d, amBat);
                if(isHost && d.m1!==-1 && d.m2!==-1) setTimeout(() => engine(d), 1000);
            }
            if(d.state === 'END') endGame(isHost?d.s1:d.s2, isHost?d.s2:d.s1);
        });
    }

    function engine(d) {
        let {s1, s2, m1, m2, inn, tar} = d;
        const p1Bat = (inn===1 ? d.p1Role==='BATTING' : d.p1Role!=='BATTING');
        const b = p1Bat?m1:m2, w = p1Bat?m2:m1;
        
        if(m1 === m2) {
            if(inn === 1) { inn=2; tar=(p1Bat?s1:s2)+1; } else { update(ref(db, 'rooms/'+rID), {state:'END', s1, s2}); return; }
        } else {
            const r = b===0?w:b; if(p1Bat) s1+=r; else s2+=r;
            if(inn===2 && (p1Bat?s1:s2)>=tar) { update(ref(db, 'rooms/'+rID), {state:'END', s1, s2}); return; }
        }
        update(ref(db, 'rooms/'+rID), {s1, s2, m1:-1, m2:-1, inn, tar});
    }

    // --- HELPERS ---
    function updateUI() {
        document.getElementById('s1').innerText = g.s1;
        document.getElementById('s2').innerText = g.s2;
        document.getElementById('innTag').innerText = g.inn === 1 ? "1ST INNINGS" : `TARGET: ${g.tar}`;
        document.getElementById('gameStatus').innerText = g.role === 'BATTING' ? "YOU ARE BATTING" : "YOU ARE BOWLING";
        
        const diff = g.s1 - g.s2;
        const d1 = document.getElementById('d1');
        d1.innerText = diff > 0 ? `+${diff}` : (diff < 0 ? diff : '');
        d1.style.color = diff >= 0 ? 'var(--win)' : 'var(--rage)';
    }

    function syncUI(d, amBat) {
        document.getElementById('s1').innerText = isHost ? d.s1 : d.s2;
        document.getElementById('s2').innerText = isHost ? d.s2 : d.s1;
        document.getElementById('innTag').innerText = d.inn === 1 ? "1ST INNINGS" : `TARGET: ${d.tar}`;
        document.getElementById('gameStatus').innerText = amBat ? "BATTING" : "BOWLING";
        renderMoves(isHost?d.m1:d.m2, isHost?d.m2:d.m1);
    }

    function renderMoves(p, o) {
        const m1 = document.getElementById('m1');
        const m2 = document.getElementById('m2');
        m1.innerText = p === -1 ? '-' : p;
        if (o === '?') { m2.innerText = '?'; m2.className = 'move-num waiting'; }
        else { m2.innerText = o === -1 ? '-' : o; m2.className = 'move-num'; }
    }

    function endGame(s1, s2) {
        document.getElementById('overlay-end').style.display = 'flex';
        document.getElementById('f1').innerText = s1;
        document.getElementById('f2').innerText = s2;
        document.getElementById('resTitle').innerText = s1 > s2 ? "VICTORY" : (s1===s2 ? "DRAW" : "DEFEAT");
        document.getElementById('resSub').innerText = s1 > s2 ? `WON BY ${s1-s2} RUNS` : `LOST BY ${s2-s1} RUNS`;
    }

    window.pickRole = (r) => {
        if(isCPU) { g.role = r; nav('game'); updateUI(); }
        else update(ref(db, 'rooms/'+rID), { p1Role: isHost?r:(r==='BATTING'?'BOWLING':'BATTING'), state:'PLAYING' });
    }

    window.setSide = (s) => { tossSide = s; document.getElementById('btn-odd').className = s==='ODD'?'btn-large':'btn-large btn-outline'; document.getElementById('btn-even').className = s==='EVEN'?'btn-large':'btn-large btn-outline'; };
    
    const fxOut = () => { const f = document.getElementById('fx-out'); f.style.display='block'; setTimeout(()=>f.style.display='none', 500); };
    const showBanner = (t) => { const b = document.getElementById('banner'); b.innerText = t; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 3000); };

    // Grids
    const makeGrid = (id, fn) => {
        const div = document.getElementById(id);
        for(let i=0; i<=10; i++) {
            let b = document.createElement('button');
            b.innerText = i;
            b.onclick = () => fn(i);
            div.appendChild(b);
        }
    };

    makeGrid('tossGrid', (n) => isCPU ? cpuToss(n) : update(ref(db, 'rooms/'+rID), { [isHost?'t1':'t2']: n, tSide: tossSide }));
    makeGrid('gameGrid', (n) => { if(isCPU) runCPUTurn(n); else update(ref(db, 'rooms/'+rID), { [isHost?'m1':'m2']: n }); });

    window.copyCode = () => { navigator.clipboard.writeText(rID); alert("Copied!"); };
</script>
</body>
</html>